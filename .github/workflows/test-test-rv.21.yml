name: Snyk Security Scan

on:
  push:
  pull_request:
  schedule:
    - cron: '18 7 * * 1' # Kjør ukentlig på mandager kl 07:18 UTC

permissions:
  contents: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🛠️ Set up Snyk CLI
        uses: snyk/actions/setup@0.4.0

      - name: 🔍 Check Snyk CLI version
        run: snyk --version

      - name: 🔎 Run Snyk Code Test
        continue-on-error: true
        run: snyk code test --sarif --json-file-output=snyk_code.sarif --debug
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 🔍 Run Snyk Infrastructure as Code (IaC) Test
        continue-on-error: true
        run: |
          snyk iac test ./modules --sarif --json-file-output=snyk_iac.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 📦 Merge SARIF results (if needed)
        run: |
          jq -s 'reduce .[] as $item ({}; .runs += $item.runs)' snyk_code.sarif snyk_iac.sarif > snyk_combined.sarif
        if: success() || failure()

      - name: ☁️ Upload results to GitHub Code Scanning
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk_combined.sarif
