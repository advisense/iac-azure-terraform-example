name: Snyk Security Scan

on:
  push:
  pull_request:
  schedule:
    - cron: '18 7 * * 1' # Kj√∏r ukentlig p√• mandager kl 07:18 UTC

permissions:
  contents: read

jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Set up Snyk CLI
        uses: snyk/actions/setup@0.4.0

      - name: üîç Check Snyk CLI version
        run: snyk --version

      - name: üîé Run Snyk Code Test
        continue-on-error: true
        run: snyk code test --sarif --json-file-output=snyk_code.sarif --debug
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: üîç Run Snyk Infrastructure as Code (IaC) Test
        continue-on-error: true
        run: |
          snyk iac test ./modules --sarif --json-file-output=snyk_iac.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: üì¶ Merge SARIF results (if needed)
        run: |
          if [ -f snyk_code.sarif ] && [ -f snyk_iac.sarif ]; then
            jq -s 'reduce .[] as $item ({}; .runs += $item.runs)' snyk_code.sarif snyk_iac.sarif > snyk_combined.sarif
          else
            echo '{}' > snyk_combined.sarif
          fi
        if: always()

      - name: ‚òÅÔ∏è Upload results to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk_combined.sarif